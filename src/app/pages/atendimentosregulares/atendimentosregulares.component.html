<app-menu></app-menu>

<div class="container">

    <mat-card class="patient-header">
        <mat-card-header>
            <mat-card-title>Atendimento de {{ paciente?.nome || 'Carregando...' }}</mat-card-title>
            <mat-card-subtitle *ngIf="paciente">
              <div>Idade: {{ calcularIdade(paciente.dataNascimento) }} anos</div>
            
              <span *ngIf="informacoesIniciais?.doencasCronicas?.usa">
                Doenças: {{ informacoesIniciais.doencasCronicas.quaisDoencas }}
              </span>
              <span *ngIf="informacoesIniciais && !informacoesIniciais.doencasCronicas?.usa">
                Doenças: Nenhuma
              </span>
              
              <br>
              
              <span *ngIf="informacoesIniciais?.alergias?.usa">
                Alergias: {{ informacoesIniciais.alergias.quaisAlergias }}
              </span>
              <span *ngIf="informacoesIniciais && !informacoesIniciais.alergias?.usa">
                Alergias: Nenhuma
              </span>
              
              <br>
              
              <span *ngIf="informacoesIniciais?.medicamentos?.usa">
                Medicamentos: {{ informacoesIniciais.medicamentos.quaisMedicamentos }}
              </span>
              <span *ngIf="informacoesIniciais && !informacoesIniciais.medicamentos?.usa">
                Medicamentos: Nenhum
              </span>
            </mat-card-subtitle>
            
          </mat-card-header>
    </mat-card>

    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ isEdicao ? 'Editar Consulta Regular' : 'Consulta Regular' }}</mat-card-title>
      </mat-card-header>
    
      <mat-form-field appearance="outline" class="full-width" style="margin: 0 16px;">
        <mat-label>Adicione um título para a consulta</mat-label>
        <textarea matInput [(ngModel)]="tituloConsulta" [ngModelOptions]="{standalone: true}" rows="1"></textarea>
      </mat-form-field>
    
      <mat-card-subtitle style="margin: 0 16px;">Dados completos do paciente</mat-card-subtitle>
    

      <mat-card-content>
        <form [formGroup]="consultaForm" (ngSubmit)="onSubmit()">
          <!-- Seção 1: Dados Antropométricos -->
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>1. Dados Antropométricos e Percepção do Peso</mat-card-title>
            </mat-card-header>
            
            <mat-card-content>
              <div class="row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Peso Atual (kg)</mat-label>
                  <input matInput type="number" step="0.1" formControlName="pesoAtual" required>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Peso Habitual (kg)</mat-label>
                  <input matInput type="number" step="0.1" formControlName="pesoHabitual">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Altura Atual (cm)</mat-label>
                  <input matInput type="number" step="0.1" formControlName="alturaAtual" required>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Fator de Atividade Física</mat-label>
                  <mat-select formControlName="fatorAtividadeFisica">
                    <mat-option *ngFor="let fator of fatores" [value]="fator.valor">
                      {{ fator.descricao }} ({{ fator.valor }})
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <div class="full-width" style="margin-top: 10px;">
                  <button mat-raised-button color="primary" type="button" (click)="calcularTMB_GET()">Calcular TMB e GET</button>
                </div>
                
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>TMB (kcal)</mat-label>
                  <input matInput formControlName="tmb" >
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>GET (kcal)</mat-label>
                  <input matInput formControlName="get" >
                </mat-form-field>
              </div>

              <!--perda de peso-->
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>Teve perda de peso recente?</mat-panel-title>
                </mat-expansion-panel-header>
                
                <div formGroupName="perdaPeso">
                  <mat-slide-toggle formControlName="teve">Sim</mat-slide-toggle>
                  
                  <div *ngIf="consultaForm.get('perdaPeso.teve')?.value" class="expansion-content">
                    <div class="row">
                      <mat-form-field appearance="outline">
                        <mat-label>Em quanto tempo?</mat-label>
                        <input matInput formControlName="tempo">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Quantos quilos perdeu?</mat-label>
                        <input matInput type="number" step="0.1" formControlName="quantidade">
                      </mat-form-field>
                    </div>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Motivo da perda</mat-label>
                      <textarea matInput formControlName="motivo" rows="2"></textarea>
                    </mat-form-field>
                  </div>
                </div>
              </mat-expansion-panel>

              <!--Ganho de peso-->
              <mat-expansion-panel>
                  <mat-expansion-panel-header>
                    <mat-panel-title>Teve ganho de peso recente?</mat-panel-title>
                  </mat-expansion-panel-header>
                  
                  <div formGroupName="ganhoPeso">
                    <mat-slide-toggle formControlName="teve">Sim</mat-slide-toggle>
                    
                    <div *ngIf="consultaForm.get('ganhoPeso.teve')?.value" class="expansion-content">
                      <div class="row">
                        <mat-form-field appearance="outline">
                          <mat-label>Em quanto tempo?</mat-label>
                          <input matInput formControlName="tempo">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Quantos quilos ganhou?</mat-label>
                          <input matInput type="number" step="0.1" formControlName="quantidade">
                        </mat-form-field>
                      </div>

                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Motivo do ganho</mat-label>
                        <textarea matInput formControlName="motivo" rows="2"></textarea>
                      </mat-form-field>
                    </div>
                  </div>
                </mat-expansion-panel>

            </mat-card-content>
          </mat-card>

          <!-- Seção 2: Acompanhamento e Evolução -->
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>2. Acompanhamento e Evolução</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Como você se sentiu desde a última consulta?</mat-label>
                <textarea matInput formControlName="sentimentosDesdeUltimaConsulta"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Conseguiu seguir o plano alimentar proposto?</mat-label>
                <textarea matInput formControlName="seguiuPlano"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Houve alguma dificuldade específica em manter a alimentação?</mat-label>
                <textarea matInput formControlName="dificuldadesAlimentacao"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Percebeu melhora nos sintomas relacionados à alimentação?</mat-label>
                <textarea matInput formControlName="sintomasMelhoraram"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Sentiu mais disposição ou energia?</mat-label>
                <textarea matInput formControlName="disposicaoEnergia"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <!-- Seção 3: Comportamento Alimentar -->
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>3. Comportamento Alimentar</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Houve episódios de compulsão ou exagero alimentar?</mat-label>
                <textarea matInput formControlName="compulsaoAlimentar"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Em quais momentos do dia você sentiu mais fome ou vontade de comer?</mat-label>
                <textarea matInput formControlName="momentosFome"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Está fazendo refeições nos horários combinados?</mat-label>
                <textarea matInput formControlName="horariosRefeicao"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Como tem sido sua fome e saciedade?</mat-label>
                <textarea matInput formControlName="fomeSaciedade"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <!-- Seção 4: Aspectos Psicológicos e Sociais -->
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>4. Aspectos Psicológicos e Sociais</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Como está o seu humor nos últimos dias?</mat-label>
                <textarea matInput formControlName="humor"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Alguma situação de estresse tem afetado sua alimentação?</mat-label>
                <textarea matInput formControlName="estresseAfetandoAlimentacao"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Teve apoio da família/amigos nesse processo?</mat-label>
                <textarea matInput formControlName="apoioFamiliar"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <!-- Seção 5: Feedback e Ajustes -->
          <mat-card class="section-card">
            <mat-card-header>
              <mat-card-title>5. Feedback e Ajustes</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>O que gostaria de ajustar no plano atual?</mat-label>
                <textarea matInput formControlName="ajustesPlano"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Há alimentos que gostaria de incluir ou excluir?</mat-label>
                <textarea matInput formControlName="alimentosIncluirExcluir"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Você sente necessidade de mais flexibilidade ou variedade?</mat-label>
                <textarea matInput formControlName="necessidadeFlexibilidade"></textarea>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <div class="button-container">
            <button mat-raised-button color="warn" type="button" (click)="cancelar()">
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="loading">
              <span *ngIf="!loading">Salvar Consulta</span>
              <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
            </button>
          </div>

        


